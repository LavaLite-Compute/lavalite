#!/usr/bin/env python3
import sys
import subprocess
import argparse
from concurrent.futures import ThreadPoolExecutor, as_completed

def ssh_command(host, command, timeout=10):
    """Execute command on remote host via SSH"""
    ssh_cmd = ['ssh', '-o', 'ConnectTimeout=5',
               '-o', 'StrictHostKeyChecking=no',
               host, command]
    try:
        result = subprocess.run(ssh_cmd,
                                capture_output=True,
                                text=True,
                                timeout=timeout)
        return (host, result.returncode, result.stdout, result.stderr)
    except subprocess.TimeoutExpired:
        return (host, 124, '', 'SSH timeout')
    except Exception as e:
        return (host, 255, '', str(e))

def run_parallel(hosts, command, parallel=16, timeout=10):
    """Run command on multiple hosts in parallel"""
    results = {}
    with ThreadPoolExecutor(max_workers=parallel) as executor:
        futures = {executor.submit(ssh_command, host, command, timeout): host
                   for host in hosts}

        for future in as_completed(futures):
            host, rc, stdout, stderr = future.result()
            results[host] = (rc, stdout, stderr)
            if rc == 0:
                print(f"[{host}] OK")
            else:
                print(f"[{host}] FAILED: {stderr}")

    return results

def main():
    parser = argparse.ArgumentParser(description='LavaLite control utility')
    parser.add_argument('--hosts', help='Comma-separated host list')
    parser.add_argument('--file', help='File with one host per line')
    parser.add_argument('--parallel', type=int, default=16)
    parser.add_argument('--timeout', type=int, default=10)
    parser.add_argument('daemon', choices=['lim', 'sbatch'])
    parser.add_argument('action', choices=['start', 'stop', 'restart',
                                           'reload', 'status', 'config-check'])

    args = parser.parse_args()

    # Get host list
    if args.hosts:
        hosts = [h.strip() for h in args.hosts.split(',')]
    elif args.file:
        with open(args.file) as f:
            hosts = [line.strip() for line in f if line.strip()]
    else:
        print("Error: specify --hosts or --file", file=sys.stderr)
        sys.exit(3)

    # Build systemctl command
    daemon_name = f'lavalite-{args.daemon}'
    if args.action == 'config-check':
        cmd = f'{daemon_name} --config-check'
    else:
        cmd = f'sudo systemctl {args.action} {daemon_name}'

    # Execute
    results = run_parallel(hosts, cmd, args.parallel, args.timeout)

    # Check for failures
    failures = [h for h, (rc, _, _) in results.items() if rc != 0]
    sys.exit(1 if failures else 0)

if __name__ == '__main__':
    main()
